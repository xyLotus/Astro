#!/bin/bash
# Copyright (C) 2021 bellrise

# The configure script generates the target.mk makefile dependency which
# provides the compiler, source files, destination files and so on.

text='# Auto-generated by the configure script'
target=out/target.mk


# Setup

rm -rf out
mkdir -p out


# Check for all the required variables in the code, and set some defaults.

if [ -z "$CC" ]; then
    echo 'Missing CC, defaulting to "gcc"'
    CC='gcc'
fi

if [ -z "$LD" ]; then
    echo 'Missing LD, defaulting to "ld"'
    AR='ar'
fi

if [ -z "$RESULT" ]; then
    echo "Missing RESULT, defaulting to \"out/avm\""
    RESULT=out/avm
fi

if [ -n "$SANITIZE" ]; then

    # The sanitizer only works for clang, so warn the user.
    if [ "$CC" != "clang" ]; then
        echo 'Code sanitizers only work with clang'
        return
    fi

    case $SANITIZE in
        address|ub|thread|memory)
            CFLAGS="$CFLAGS -fsanitize=$SANITIZE"
            ;;
        *)
            echo 'Unknown clang sanitizer! The possible sanitizers include:' \
            'address, ub, thread, memory.'
            exit 1
            ;;
    esac
fi

# Prepare and push the variables into the target file.

sources=$(find src -type f -name '*.c' -printf 'src/%P ')
objects=$(find src -type f -name '*.c' -printf 'out/%P ' | sed 's/\.c/\.o/g')

echo "$text

CC      := $CC
LD      := $LD
CFLAGS  := -fpic $CFLAGS
RESULT  := $RESULT

SOURCES := $sources
OBJECTS := $objects" > $target
